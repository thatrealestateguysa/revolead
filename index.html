<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RevoLead — Part 1 (v3)</title>
  <meta name="theme-color" content="#0a0a0a"/>
  <link rel="icon" href="assets/icon.png" sizes="32x32" />
  <link rel="apple-touch-icon" href="assets/icon.png" />
  <style>
    :root{
      --bg:#0a0a0a; --panel:#171717; --border:#262626; --border2:#404040; --txt:#ffffff;
      --muted:#d4d4d4; --muter:#a3a3a3; --brand:#dc2626; --brand2:#b91c1c; --brand3:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:0 auto;padding:20px 16px}
    header.bar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;background:#fff;color:#111;border:1px solid var(--border);border-radius:14px}
    .hstack{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 12px;border-radius:999px;border:1px solid var(--brand2);background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
    .btn:hover{background:var(--brand2)}
    .btn.ghost{background:transparent;color:#fff;border-color:var(--border2)}
    .btn.ghost:hover{background:#1f1f1f}
    .btn.small{padding:6px 10px;font-size:12px}
    .chip{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;background:#262626;color:#e5e5e5;font-size:12px;font-weight:700}
    .field{width:100%;padding:10px 12px;border-radius:10px;background:#0a0a0a;border:1px solid var(--border2);color:#fff}
    .label{font-size:12px;font-weight:800;color:#d4d4d4;text-transform:uppercase}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
    .hidden{display:none !important}
    .tabbar{display:flex;gap:8px;flex-wrap:wrap}
    .subtabbar{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{background:#262626;color:#e5e5e5;position:sticky;top:0;z-index:1}
    th,td{padding:8px;border-bottom:1px solid #1c1c1c;vertical-align:top;text-align:left}
    .badge{display:inline-flex;align-items:center;padding:2px 8px;background:#262626;color:#e5e5e5;border-radius:999px;font-size:12px;font-weight:600;margin:0 4px 4px 0}
    .paginate{display:flex;align-items:center;gap:8px;justify-content:flex-end;margin-top:10px}
    footer{color:#9ca3af;text-align:center;padding:24px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="bar">
      <div class="hstack">
        <img src="assets/logo.jpg" alt="RevoLead" style="height:44px;object-fit:contain">
      </div>
      <div class="hstack">
        <div id="userBadge" class="hidden hstack" style="background:#fee2e2;color:#7f1d1d;border-radius:999px;padding:4px 8px;border:1px solid #fecaca;">
          <span id="userNameBadge" style="font-weight:700;"></span>
          <button id="signOutBtn" class="btn small" style="background:transparent;color:#7f1d1d;border-color:#fca5a5;">Sign out</button>
        </div>
        <button id="signInBtn" class="btn">Sign In</button>
        <button id="openDataBtn" class="btn">Data Source</button>
        <button id="downloadTemplateBtn" class="btn">Download CSV Template</button>
        <label class="btn" style="cursor:pointer">
          <input id="csvFileInput" type="file" accept=".csv" class="hidden">
          Import CSV
        </label>
        <button id="addContactToggle" class="btn">Add Contact</button>
      </div>
    </header>

    <nav style="margin:14px 0;" class="tabbar">
      <button id="tabContacts" class="btn" type="button">Contacts</button>
      <button id="tabBulk" class="btn" type="button">Bulk</button>
    </nav>

    <!-- CONTACTS TAB -->
    <section id="contactsTab" class="">
      <section id="contactFormWrap" class="panel hidden">
        <div class="hstack" style="justify-content:space-between">
          <h2 id="formTitle" style="margin:0;font-size:18px;font-weight:800">Add Contact</h2>
          <button id="closeForm" class="btn ghost small">✕</button>
        </div>
        <form id="contactForm" style="margin-top:10px;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px">
          <input type="hidden" id="contactId">
          <div><label class="label">Name</label><input id="firstName" class="field" placeholder="e.g. Dawie" required></div>
          <div><label class="label">Surname</label><input id="lastName" class="field" placeholder="e.g. du Toit" required></div>
          <div><label class="label">Email</label><input id="email" class="field" type="email" placeholder="name@example.com"></div>
          <div><label class="label">Mobile</label><input id="mobile" class="field" placeholder="+27… or 0…"></div>
          <div><label class="label">Birthday</label><input id="birthday" class="field" type="date" data-auto=""></div>
          <div><label class="label">ID Number</label><input id="idNumber" class="field" inputmode="numeric" placeholder="South African ID (keeps 0s)"></div>
          <div style="grid-column:1/-1"><label class="label">Tags & Labels (comma‑separated)</label><input id="tags" class="field" placeholder="buyer, hot, investor"></div>
          <div style="grid-column:1/-1"><label class="label">Address</label><input id="address" class="field" placeholder="Full address"></div>
          <div><label class="label">Suburb</label><input id="suburb" class="field" placeholder="e.g. Fourways"></div>
          <div><label class="label">Street</label><input id="street" class="field" placeholder="e.g. Roos St"></div>
          <div><label class="label">Last Contact</label><input id="lastContact" class="field" type="datetime-local"></div>
          <div style="grid-column:1/-1" class="hstack">
            <button class="btn" type="submit">Save Contact</button>
            <button id="resetForm" class="btn ghost" type="button">Reset</button>
          </div>
        </form>
      </section>

      <section class="panel" style="margin-top:12px">
        <div class="hstack" style="justify-content:space-between;align-items:flex-end">
          <div>
            <h2 style="margin:0;font-size:18px;font-weight:800">Contacts</h2>
            <div style="color:#cbd5e1;font-size:13px">Selected: <b id="selectedCount">0</b> · Matches: <b id="matchCountHead">0</b></div>
          </div>
          <div class="hstack">
            <span style="font-size:12px;color:#cbd5e1">Rows/page: 15</span>
          </div>
        </div>

        <div style="margin-top:10px;overflow:auto">
          <table>
            <thead>
              <tr>
                <th><input id="selectAllPage" type="checkbox" title="Select all on this page"></th>
                <th>Name</th><th>Surname</th><th>Email</th><th>Mobile</th><th>Birthday</th><th>ID Number</th>
                <th>Tags</th><th>Address</th><th>Suburb</th><th>Street</th><th>Last Contact</th><th>Actions</th>
              </tr>
              <tr>
                <th></th>
                <th><input id="fName" class="field" placeholder="Search…"></th>
                <th><input id="fSurname" class="field" placeholder="Search…"></th>
                <th><input id="fEmail" class="field" placeholder="Search…"></th>
                <th><input id="fMobile" class="field" placeholder="Search…"></th>
                <th><input id="fBirthday" class="field" type="date"></th>
                <th><input id="fIdNumber" class="field" placeholder="Search…"></th>
                <th><input id="fTags" class="field" placeholder="tag, tag"></th>
                <th><input id="fAddress" class="field" placeholder="Search…"></th>
                <th><input id="fSuburb" class="field" placeholder="Search…"></th>
                <th><input id="fStreet" class="field" placeholder="Search…"></th>
                <th><input id="fLastContact" class="field" type="date"></th>
                <th></th>
              </tr>
            </thead>
            <tbody id="contactsTbody"></tbody>
          </table>
        </div>

        <div class="paginate">
          <button id="prevPage" class="btn small">Prev</button>
          <div style="color:#cbd5e1;font-size:12px">Page <b id="pageCur">1</b> of <b id="pageMax">1</b></div>
          <button id="nextPage" class="btn small">Next</button>
        </div>
      </section>
    </section>

    <!-- BULK TAB -->
    <section id="bulkTab" class="panel hidden">
      <div class="hstack" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h2 style="margin:0;font-size:18px;font-weight:800">Bulk</h2>
          <p style="color:#cbd5e1;font-size:13px">Use selected contacts. Tokens: <span class="chip">{{Name}}</span> <span class="chip">{{Surname}}</span> <span class="chip">{{FullName}}</span> <span class="chip">{{Suburb}}</span></p>
        </div>
        <div style="color:#cbd5e1;font-size:13px">Selected recipients: <b id="sendSelectedCount">0</b></div>
      </div>

      <div class="subtabbar">
        <button id="subtabWhatsApp" class="btn small">WhatsApp</button>
        <button id="subtabEmail" class="btn small">Email</button>
        <button id="subtabScripts" class="btn small">Scripts</button>
      </div>

      <div id="bulkWhatsApp" style="margin-top:10px">
        <div class="hstack" style="gap:8px;flex-wrap:wrap">
          <button id="genWhatsAppBtn" class="btn">Generate WhatsApp Links</button>
          <button id="openAllWA" class="btn ghost">Open All Chats</button>
          <button id="copyWAMessages" class="btn ghost">Copy All Messages</button>
        </div>
        <div style="margin-top:8px">
          <h3 style="font-size:14px">Generated WhatsApp Links</h3>
          <div id="waLinks" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px"></div>
        </div>
      </div>

      <div id="bulkEmail" class="hidden" style="margin-top:10px">
        <div class="hstack" style="gap:8px;flex-wrap:wrap">
          <label class="label">Email Subject</label>
          <input id="emailSubject" class="field" style="max-width:420px" placeholder="Subject for bulk email">
          <button id="composeEmailBtn" class="btn">Compose (mailto)</button>
          <button id="copyEmailList" class="btn ghost">Copy BCC</button>
        </div>
      </div>

      <div id="bulkScripts" class="hidden" style="margin-top:10px">
        <div style="display:grid;grid-template-columns:1fr auto;gap:8px">
          <div>
            <label class="label">Select Script</label>
            <select id="scriptSelect" class="field"></select>
          </div>
          <div class="hstack" style="align-items:flex-end">
            <button id="newScriptBtn" class="btn small">New</button>
            <button id="editScriptBtn" class="btn small">Edit</button>
            <button id="deleteScriptBtn" class="btn small">Delete</button>
          </div>
        </div>
        <div style="margin-top:8px">
          <label class="label">Message Preview</label>
          <textarea id="messagePreview" class="field" style="height:140px" placeholder="Message body using the selected script…"></textarea>
        </div>
      </div>
    </section>

    <footer>RevoLead · Part 1 · v3 · 15 rows/page pagination</footer>
  </div>

  <!-- Dialogs -->
  <dialog id="scriptModal" style="border:0;padding:0;border-radius:14px;width:min(720px,92vw)">
    <form method="dialog" class="panel" style="margin:0">
      <h3 id="scriptModalTitle" style="margin:0;font-size:18px;font-weight:800">New Script</h3>
      <div style="margin-top:10px;display:grid;gap:8px">
        <div><label class="label">Script Name</label><input id="scriptName" class="field" placeholder="e.g. Intro — Check-in" required></div>
        <div><label class="label">Default Subject (optional)</label><input id="scriptSubject" class="field" placeholder="e.g. Quick check-in"></div>
        <div><label class="label">Script Body</label><textarea id="scriptBody" class="field" style="height:160px" placeholder="Hi {{Name}}, …"></textarea></div>
        <div style="color:#9ca3af;font-size:12px">Tokens: {{Name}}, {{Surname}}, {{FullName}}, {{Suburb}}, {{Mobile}}</div>
      </div>
      <div class="hstack" style="justify-content:flex-end;margin-top:10px">
        <button id="cancelScript" class="btn ghost" value="cancel">Cancel</button>
        <button id="saveScript" class="btn" value="default">Save</button>
      </div>
    </form>
  </dialog>

  <dialog id="loginModal" style="border:0;padding:0;border-radius:14px;width:min(560px,92vw)">
    <form method="dialog" class="panel" style="margin:0">
      <h3 style="margin:0;font-size:18px;font-weight:800">Sign In</h3>
      <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div style="grid-column:1/-1"><label class="label">Email</label><input id="loginEmail" class="field" type="email" placeholder="you@example.com" required></div>
        <div><label class="label">Name</label><input id="loginName" class="field" placeholder="Your name" required></div>
        <div><label class="label">Mobile</label><input id="loginMobile" class="field" placeholder="+27… or 0…" required></div>
      </div>
      <p style="color:#9ca3af;font-size:12px;margin-top:6px">Used only to route to your personal sheet tab. Not a secure login.</p>
      <div class="hstack" style="justify-content:flex-end;margin-top:10px">
        <button id="cancelLogin" class="btn ghost" value="cancel">Cancel</button>
        <button id="confirmLogin" class="btn" value="default">Sign In</button>
      </div>
    </form>
  </dialog>

  <dialog id="dataModal" style="border:0;padding:0;border-radius:14px;width:min(720px,92vw)">
    <form method="dialog" class="panel" style="margin:0">
      <h3 style="margin:0;font-size:18px;font-weight:800">Data Source</h3>
      <p style="color:#cbd5e1;font-size:13px">Connect a <span class="chip">Google Sheet</span> via Apps Script. Each user keeps their own tab.</p>

      <div style="margin-top:10px;display:grid;gap:10px">
        <div class="hstack">
          <label class="hstack"><input type="radio" name="storageMode" value="local" id="storageLocal"><span>&nbsp;Local (browser)</span></label>
          <label class="hstack"><input type="radio" name="storageMode" value="sheet" id="storageSheet" checked><span>&nbsp;Google Sheet (Apps Script)</span></label>
        </div>
        <div id="sheetConfig" style="display:grid;gap:8px">
          <div><label class="label">Spreadsheet URL</label><input id="sheetUrl" class="field" placeholder="Paste Google Sheet URL"></div>
          <div><label class="label">Sheet Name (tab)</label><input id="sheetName" class="field" placeholder="Contacts"></div>
          <div><label class="label">Apps Script Web App URL</label><input id="webAppUrl" class="field" value="https://script.google.com/macros/s/AKfycbxnyly0KVZxWw0xOygL8KUpRMgRPZ7Rs6zTO6VjGrSGry6xtmslHbYWOS2f0pQ1WtP2Dw/exec"></div>
          <div class="hstack" style="flex-wrap:wrap">
            <button id="btnLoadFromSheet" class="btn">Load from Sheet</button>
            <button id="btnSaveToSheet" class="btn">Save to Sheet</button>
          </div>
        </div>
      </div>

      <div class="hstack" style="justify-content:flex-end;margin-top:10px">
        <button id="cancelData" class="btn ghost" value="cancel">Close</button>
        <button id="saveData" class="btn" value="default">Save</button>
      </div>
    </form>
  </dialog>

  <script>
    // ===== Helpers =====
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const uid = ()=> 'id_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4);
    const pad2 = n=> String(n).padStart(2,'0');
    const fmtDateTimeLocal = dt=>{ if(!dt) return ''; const d=new Date(dt); if(Number.isNaN(d.getTime())) return ''; return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`; };
    const toLocalInputValue = dt=>{ if(!dt) return ''; const d=new Date(dt); if(Number.isNaN(d.getTime())) return ''; return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`; };
    const normalizePhoneSA = raw=>{ if(!raw) return ''; const digits=raw.replace(/\\D+/g,''); if(!digits) return ''; if(digits.startsWith('27') && digits.length>=11) return '+'+digits; if(digits.startsWith('0') && digits.length===10) return '+27'+digits.slice(1); if(raw.trim().startsWith('+')) return raw.trim(); return raw.trim(); };
    const escapeHtml=s=>(s??'').toString().replace(/[&<>\"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;' }[c]));
    const saveLocal=(k,v)=>localStorage.setItem(k, JSON.stringify(v));
    const loadLocal=(k,fb)=>{ try{ const v=JSON.parse(localStorage.getItem(k)); return v??fb; } catch { return fb; } };
    const isMoreComplete=(a,b)=>{ const s=c=>Object.values(c).reduce((t,v)=>t+(v?1:0),0); return s(a)>=s(b); };

    function deriveBirthdayFromSAID(id){
      const m = String(id||'').replace(/\\D/g,'').match(/^(\\d{2})(\\d{2})(\\d{2})/);
      if(!m) return '';
      const yy = parseInt(m[1],10), mm = parseInt(m[2],10), dd = parseInt(m[3],10);
      if(mm<1||mm>12||dd<1||dd>31) return '';
      const curYY = new Date().getFullYear() % 100;
      const year = (yy <= curYY ? 2000 : 1900) + yy;
      const d = new Date(year, mm-1, dd);
      if(Number.isNaN(d.getTime()) || d.getMonth()!==mm-1 || d.getDate()!==dd) return '';
      return d.toISOString().slice(0,10);
    }

    // ===== State =====
    const STORAGE = { contacts:'revoLead_contacts_v3', scripts:'revoLead_scripts_v3', settings:'revoLead_settings_v3', user:'revoLead_user_v3' };
    let contacts = loadLocal(STORAGE.contacts, []);
    let scripts = loadLocal(STORAGE.scripts, null) || [
      { id: uid(), name: 'Intro — Buyer/Seller Check‑in', subject: 'Quick property check‑in', body: 'Hi {{Name}}, it\\'s Dawie from Keller Williams Explore. Just touching base — are you planning any property moves in {{Suburb}} this year? If you\\'d like an updated valuation or area insights, I\\'m happy to help.\\n\\nBest,\\nDawie' },
      { id: uid(), name: 'Open House Invite', subject: 'You\\'re invited: Open House', body: 'Hi {{FullName}}, quick invite to an open house in {{Suburb}}. Reply “YES” and I\\'ll send details. — Dawie' }
    ];
    saveLocal(STORAGE.scripts, scripts);

    let settings = loadLocal(STORAGE.settings, {
      mode:'sheet',
      sheetUrl:'',
      sheetId:'',
      sheetName:'Contacts',
      webAppUrl:'https://script.google.com/macros/s/AKfycbxnyly0KVZxWw0xOygL8KUpRMgRPZ7Rs6zTO6VjGrSGry6xtmslHbYWOS2f0pQ1WtP2Dw/exec'
    });
    let currentUser = loadLocal(STORAGE.user, null);

    let filters = { name:'', surname:'', email:'', mobile:'', birthday:'', idNumber:'', tags:'', address:'', suburb:'', street:'', lastContactDate:'' };
    let selectedIds = new Set();

    // Pagination
    const PAGE_SIZE = 15;
    let currentPage = 1;

    function tokenize(str,c){ const full=[c.firstName,c.lastName].filter(Boolean).join(' ').trim(); return (str||'').replace(/\\{\\{\\s*Name\\s*\\}\\}/g,c.firstName||'').replace(/\\{\\{\\s*Surname\\s*\\}\\}/g,c.lastName||'').replace(/\\{\\{\\s*FullName\\s*\\}\\}/g,full).replace(/\\{\\{\\s*Suburb\\s*\\}\\}/g,c.suburb||'').replace(/\\{\\{\\s*Mobile\\s*\\}\\}/g,c.mobile||''); }
    function currentScript(){ const sel=$('#scriptSelect'); if(!sel) return null; return scripts.find(s=>s.id===sel.value)||null; }

    function filterContact(c){
      const ic=s=>(s||'').toLowerCase();
      if(filters.name && !ic(c.firstName).includes(ic(filters.name))) return false;
      if(filters.surname && !ic(c.lastName).includes(ic(filters.surname))) return false;
      if(filters.email && !ic(c.email).includes(ic(filters.email))) return false;
      if(filters.mobile && !ic(c.mobile).includes(ic(filters.mobile))) return false;
      if(filters.birthday && (c.birthday||'').slice(0,10)!==filters.birthday) return false;
      if(filters.idNumber && !ic(String(c.idNumber)).includes(ic(filters.idNumber))) return false;
      if(filters.tags){
        const want=ic(filters.tags).split(',').map(s=>s.trim()).filter(Boolean);
        const have=(c.tags||[]).map(t=>t.toLowerCase());
        if(!want.every(t=>have.some(h=>h.includes(t)))) return false;
      }
      if(filters.address && !ic(c.address).includes(ic(filters.address))) return false;
      if(filters.suburb && !ic(c.suburb).includes(ic(filters.suburb))) return false;
      if(filters.street && !ic(c.street).includes(ic(filters.street))) return false;
      if(filters.lastContactDate){ const lc=(c.lastContact||'').slice(0,10); if(lc!==filters.lastContactDate) return false; }
      return true;
    }

    function filteredContacts(){ return contacts.filter(c=>filterContact(c)); }
    function pageCount(){ return Math.max(1, Math.ceil(filteredContacts().length / PAGE_SIZE)); }
    function pageSlice(){
      const rows = filteredContacts();
      const max = pageCount();
      if(currentPage>max) currentPage=max;
      const start = (currentPage-1)*PAGE_SIZE;
      return rows.slice(start, start+PAGE_SIZE);
    }

    function updateSelectedCounts(){
      $('#selectedCount').textContent=String(selectedIds.size);
      const filtered=new Set(filteredContacts().map(c=>c.id));
      const count=[...selectedIds].filter(id=>filtered.has(id)).length;
      $('#sendSelectedCount').textContent=String(count);
      // select all on page checkbox
      const onPage = pageSlice().map(c=>c.id);
      const selectedOnPage = onPage.every(id=>selectedIds.has(id)) && onPage.length>0;
      $('#selectAllPage').checked = selectedOnPage;
    }

    function renderScripts(){
      const sel=$('#scriptSelect'); if(!sel) return;
      sel.innerHTML='';
      scripts.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; sel.appendChild(o); });
      if(scripts.length) sel.value=scripts[0].id;
      updatePreview();
    }

    function renderContacts(){
      const tbody=$('#contactsTbody'); if(!tbody) return;
      tbody.innerHTML='';
      const rows = pageSlice();
      $('#matchCountHead').textContent = `${filteredContacts().length} match${filteredContacts().length===1?'':'es'}`;
      $('#pageCur').textContent = String(currentPage);
      $('#pageMax').textContent = String(pageCount());
      rows.forEach(c=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" data-id="${c.id}" class="rowSel" ${selectedIds.has(c.id)?'checked':''}></td>
          <td>${escapeHtml(c.firstName||'')}</td>
          <td>${escapeHtml(c.lastName||'')}</td>
          <td>${escapeHtml(c.email||'')}</td>
          <td>${escapeHtml(c.mobile||'')}</td>
          <td>${(c.birthday||'').slice(0,10)}</td>
          <td>${escapeHtml(String(c.idNumber||''))}</td>
          <td>${(c.tags||[]).map(t=>`<span class="badge">${escapeHtml(t)}</span>`).join('')}</td>
          <td>${escapeHtml(c.address||'')}</td>
          <td>${escapeHtml(c.suburb||'')}</td>
          <td>${escapeHtml(c.street||'')}</td>
          <td>${fmtDateTimeLocal(c.lastContact)}</td>
          <td><div class="hstack"><button class="btn small ghost" data-act="edit" data-id="${c.id}">Edit</button><button class="btn small ghost" data-act="mark" data-id="${c.id}">Mark Now</button><button class="btn small ghost" data-act="del" data-id="${c.id}">Delete</button></div></td>
        `;
        tbody.appendChild(tr);
      });
      updateSelectedCounts();
    }

    function updatePreview(){
      const sc=currentScript(); if(!sc) return;
      const firstSel=[...selectedIds][0];
      const c=contacts.find(x=>x.id===firstSel)||contacts[0]||{};
      const subj=$('#emailSubject'); if(subj && !subj.value && sc.subject) subj.value=sc.subject;
      const preview=$('#messagePreview'); if(preview) preview.value = tokenize(sc.body||'', c);
    }

    function loadToForm(c){
      $('#contactId').value=c.id||'';
      $('#firstName').value=c.firstName||'';
      $('#lastName').value=c.lastName||'';
      $('#email').value=c.email||'';
      $('#mobile').value=c.mobile||'';
      $('#birthday').value=(c.birthday||'').slice(0,10);
      $('#idNumber').value=(c.idNumber==null?'':String(c.idNumber));
      $('#tags').value=(c.tags||[]).join(', ');
      $('#address').value=c.address||'';
      $('#suburb').value=c.suburb||'';
      $('#street').value=c.street||'';
      $('#lastContact').value=toLocalInputValue(c.lastContact);
      showForm(true, c.id ? 'Edit Contact' : 'Add Contact');
    }

    function formToData(){
      const id=$('#contactId').value || uid();
      const firstName=$('#firstName').value.trim();
      const lastName=$('#lastName').value.trim();
      const email=$('#email').value.trim();
      const mobile=$('#mobile').value.trim();
      const idNumberRaw=$('#idNumber').value;
      let birthday=$('#birthday').value || '';
      if(!birthday && idNumberRaw) birthday = deriveBirthdayFromSAID(idNumberRaw);
      const idNumber=String(idNumberRaw ?? '');
      const tags=$('#tags').value.split(',').map(s=>s.trim()).filter(Boolean);
      const address=$('#address').value.trim();
      const suburb=$('#suburb').value.trim();
      const street=$('#street').value.trim();
      const lastContact=$('#lastContact').value ? new Date($('#lastContact').value).toISOString() : '';
      const mobileNorm=normalizePhoneSA(mobile);
      return { id, firstName, lastName, email, mobile:mobileNorm||mobile, birthday, idNumber, tags, address, suburb, street, lastContact };
    }

    function showForm(show, title='Add Contact'){ $('#contactFormWrap').classList.toggle('hidden', !show); $('#formTitle').textContent=title; }

    function upsertContact(data){ const idx=contacts.findIndex(c=>c.id===data.id); if(idx>=0) contacts[idx]=data; else contacts.push(data); saveLocal(STORAGE.contacts, contacts); renderContacts(); }
    function deleteContact(id){ contacts=contacts.filter(c=>c.id!==id); selectedIds.delete(id); saveLocal(STORAGE.contacts, contacts); renderContacts(); }

    // CSV
    const csvEscape=v=>{ if(v==null) return ''; const s=String(v); return /[\",\n\r]/.test(s)?'\"'+s.replace(/\"/g,'\"\"')+'\"':s; };
    function triggerDownload(content, filename, mime='text/plain'){ const blob=new Blob([content],{type:mime}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }
    function downloadTemplate(){ const headers=['Name','Surname','Email','Mobile','Birthday','ID Number','Tags','Address','Suburb','Street','Last Contact']; const sample=[ ['Dawie','du Toit','dawie@example.com','0821234567','1990-05-10','0900105800081','buyer, hot','32 Roos St, Fourways Golf Park','Fourways','Roos St',''], ['Elca','Minnaar','elca@example.com','0712345678','','','','','Fourways','',''] ]; const csv=[headers.join(',')].concat(sample.map(r=>r.map(csvEscape).join(','))).join('\\n'); triggerDownload(csv,'revolead_template.csv','text/csv'); }
    function parseCSV(text){ const rows=[]; let i=0, field='', row=[], inQuotes=false; while(i<text.length){ const ch=text[i]; if(inQuotes){ if(ch==='\"'){ if(text[i+1]==='\"'){ field+='\"'; i++; } else { inQuotes=false; } } else { field+=ch; } } else { if(ch==='\"'){ inQuotes=true; } else if(ch===','){ row.push(field); field=''; } else if(ch==='\\n' || ch==='\\r'){ if(field!=='' || row.length){ row.push(field); rows.push(row); row=[]; field=''; } if(ch==='\\r' && text[i+1]==='\\n') i++; } else { field+=ch; } } i++; } if(field!=='' || row.length){ row.push(field); rows.push(row); } return rows; }
    function importCSV(text){ const rows=parseCSV(text); if(!rows.length) return 0; const header=rows[0].map(h=>h.trim().toLowerCase()); const idx=name=>header.indexOf(name.toLowerCase()); const get=(r,name)=>{ const i=idx(name); return i>=0 ? (r[i]||'').trim() : ''; }; let added=0; for(let r=1;r<rows.length;r++){ const row=rows[r]; if(!row || row.every(v=>!v)) continue; const idNum = get(row,'id number'); const bday = get(row,'birthday') || deriveBirthdayFromSAID(idNum); const data={ id: uid(), firstName:get(row,'name'), lastName:get(row,'surname'), email:get(row,'email'), mobile: normalizePhoneSA(get(row,'mobile')), birthday:bday, idNumber:idNum, tags:(get(row,'tags')||'').split(',').map(s=>s.trim()).filter(Boolean), address:get(row,'address'), suburb:get(row,'suburb'), street:get(row,'street'), lastContact: get(row,'last contact') ? new Date(get(row,'last contact')).toISOString() : '' }; const matchIdx=contacts.findIndex(c=> (c.firstName?.toLowerCase()===data.firstName.toLowerCase() && c.lastName?.toLowerCase()===data.lastName.toLowerCase() && ((c.mobile && data.mobile && c.mobile===data.mobile) || (c.email && data.email && c.email.toLowerCase()===data.email.toLowerCase())))); if(matchIdx>=0){ const merged={...contacts[matchIdx], ...data}; if(isMoreComplete(merged, contacts[matchIdx])) contacts[matchIdx]=merged; } else { contacts.push(data); added++; } } saveLocal(STORAGE.contacts, contacts); currentPage=1; renderContacts(); return added; }

    // Backend (Apps Script)
    async function loadFromSheet(){ try{ if(settings.mode!=='sheet') throw new Error('Set storage to Sheet first'); if(!settings.webAppUrl) throw new Error('Missing Web App URL'); const url = settings.webAppUrl + '?sheet=' + encodeURIComponent(settings.sheetName||'Contacts'); const res = await fetch(url, { method:'GET' }); const data = await res.json(); if(data.error) throw new Error(data.error); const rows = Array.isArray(data.rows) ? data.rows : []; contacts = rows.map(r=>{ const idNum = (r.idNumber==null?'':String(r.idNumber)); const bday = (r.birthday && String(r.birthday).length>=8) ? String(r.birthday).slice(0,10) : deriveBirthdayFromSAID(idNum); return { id: r.id||uid(), firstName:r.firstName||'', lastName:r.lastName||'', email:r.email||'', mobile:r.mobile||'', birthday:bday||'', idNumber:idNum, tags:(typeof r.tags==='string'? r.tags.split(',').map(s=>s.trim()).filter(Boolean):(r.tags||[])), address:r.address||'', suburb:r.suburb||'', street:r.street||'', lastContact:r.lastContact||'' }; }); saveLocal(STORAGE.contacts, contacts); currentPage=1; renderContacts(); alert('Loaded ' + contacts.length + ' contact' + (contacts.length===1?'':'s') + ' from Sheet.'); } catch(err){ alert('Load failed: '+ err.message); } }
    async function saveToSheet(){ try{ if(settings.mode!=='sheet') throw new Error('Set storage to Sheet first'); if(!settings.webAppUrl) throw new Error('Missing Web App URL'); const rows = contacts.map(c=>({ ...c, idNumber: (c.idNumber==null?'':String(c.idNumber)) })); const payload = { sheet: settings.sheetName||'Contacts', mode:'replace', rows }; const res = await fetch(settings.webAppUrl, { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body: 'data='+encodeURIComponent(JSON.stringify(payload)) }); const data = await res.json(); if(data.error) throw new Error(data.error); alert('Saved ' + (data?.count ?? rows.length) + ' contacts to Sheet.'); } catch(err){ alert('Save failed: '+ err.message); } }

    // Tabs
    function activateTab(which){ const isBulk = which==='bulk'; $('#contactsTab').classList.toggle('hidden', isBulk); $('#bulkTab').classList.toggle('hidden', !isBulk); }
    function activateSub(which){ $('#bulkWhatsApp').classList.toggle('hidden', which!=='wa'); $('#bulkEmail').classList.toggle('hidden', which!=='email'); $('#bulkScripts').classList.toggle('hidden', which!=='scripts'); }

    // ===== Boot =====
    document.addEventListener('DOMContentLoaded', ()=>{
      // Top tabs as red buttons
      $('#tabContacts').addEventListener('click', ()=>activateTab('contacts'));
      $('#tabBulk').addEventListener('click', ()=>activateTab('bulk'));

      // Bulk subtabs
      $('#subtabWhatsApp').addEventListener('click', ()=>activateSub('wa'));
      $('#subtabEmail').addEventListener('click', ()=>activateSub('email'));
      $('#subtabScripts').addEventListener('click', ()=>activateSub('scripts'));
      activateSub('wa'); // default

      // Render base
      renderScripts(); renderContacts();

      // Header controls
      $('#downloadTemplateBtn').addEventListener('click', downloadTemplate);
      $('#csvFileInput').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ const added=importCSV(String(r.result||'')); alert('Imported '+added+' new contact'+(added===1?'':'s')+'.'); e.target.value=''; }; r.readAsText(f); });
      $('#addContactToggle').addEventListener('click', ()=>loadToForm({}));

      // Form
      $('#closeForm').addEventListener('click', ()=>showForm(false));
      $('#resetForm').addEventListener('click', ()=>loadToForm({ id: $('#contactId').value }));
      $('#contactForm').addEventListener('submit', (e)=>{ e.preventDefault(); const data=formToData(); if(!data.firstName||!data.lastName){ alert('Name and Surname are required.'); return; } if(!data.email && !data.mobile){ if(!confirm('No email or mobile captured. Save anyway?')) return; } upsertContact(data); showForm(false); });
      // Auto birthday
      $('#idNumber').addEventListener('input', (e)=>{ const v=e.target.value; const b=deriveBirthdayFromSAID(v); const bd=$('#birthday'); if(b && (!bd.value || bd.dataset.auto==='1')){ bd.value=b; bd.dataset.auto='1'; } });
      $('#birthday').addEventListener('input', ()=>{ $('#birthday').dataset.auto=''; });

      // Filters
      const fmap=[ ['fName','name'], ['fSurname','surname'], ['fEmail','email'], ['fMobile','mobile'], ['fBirthday','birthday'], ['fIdNumber','idNumber'], ['fTags','tags'], ['fAddress','address'], ['fSuburb','suburb'], ['fStreet','street'], ['fLastContact','lastContactDate'] ];
      fmap.forEach(([id,key])=>{ const el=document.getElementById(id); if(!el) return; const h=(e)=>{ filters[key]=e.target.value.trim(); currentPage=1; renderContacts(); }; el.addEventListener('input', h); el.addEventListener('change', h); });

      // Table interactions
      $('#contactsTbody').addEventListener('click', (e)=>{
        const cb=e.target.closest('input.rowSel');
        if(cb){ const id=cb.dataset.id; cb.checked?selectedIds.add(id):selectedIds.delete(id); updateSelectedCounts(); return; }
        const btn=e.target.closest('button'); if(!btn) return;
        const id=btn.dataset.id; const act=btn.dataset.act; const c=contacts.find(x=>x.id===id); if(!c) return;
        if(act==='edit') loadToForm(c);
        if(act==='del'){ if(confirm('Delete this contact?')) deleteContact(id); }
        if(act==='mark'){ c.lastContact=new Date().toISOString(); upsertContact(c); }
      });

      // Select all (page)
      $('#selectAllPage').addEventListener('change', (e)=>{
        const rows = pageSlice();
        if(e.target.checked) rows.forEach(c=>selectedIds.add(c.id));
        else rows.forEach(c=>selectedIds.delete(c.id));
        renderContacts();
      });

      // Pagination
      $('#prevPage').addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; renderContacts(); } });
      $('#nextPage').addEventListener('click', ()=>{ if(currentPage<pageCount()){ currentPage++; renderContacts(); } });

      // Scripts
      $('#scriptSelect')?.addEventListener('change', updatePreview);
      $('#newScriptBtn').addEventListener('click', ()=>openScriptModal());
      $('#editScriptBtn').addEventListener('click', ()=>{ const sc=currentScript(); if(!sc) return; openScriptModal(sc); });
      $('#deleteScriptBtn').addEventListener('click', ()=>{ const sc=currentScript(); if(!sc) return; if(!confirm('Delete script \"'+sc.name+'\"?')) return; scripts=scripts.filter(s=>s.id!==sc.id); saveLocal(STORAGE.scripts, scripts); renderScripts(); });

      // Bulk actions
      $('#genWhatsAppBtn').addEventListener('click', ()=>{ const sc=currentScript(); if(!sc) return alert('Select a script first'); const wrap=$('#waLinks'); wrap.innerHTML=''; const targets=contacts.filter(c=>selectedIds.has(c.id) && c.mobile); if(!targets.length) return alert('Select contacts first'); targets.forEach(c=>{ const msg=tokenize(sc.body||'', c); const num=normalizePhoneSA(c.mobile||''); const url='https://wa.me/'+encodeURIComponent(num.replace(/\\D/g,''))+'?text='+encodeURIComponent(msg); const row=document.createElement('div'); row.className='panel'; row.style.padding='10px'; row.style.display='flex'; row.style.alignItems='center'; row.style.justifyContent='space-between'; row.innerHTML=`<div style="font-size:13px"><div style="font-weight:700">${escapeHtml(c.firstName||'')} ${escapeHtml(c.lastName||'')}</div><div style="color:#9ca3af">${escapeHtml(num)}</div></div><div class="hstack"><a class="btn" target="_blank" rel="noopener" href="${url}">Open</a><button class="btn ghost" data-copy="${msg.replace(/"/g,'&quot;')}">Copy Message</button></div>`; wrap.appendChild(row); }); });
      $('#waLinks').addEventListener('click', (e)=>{ const b=e.target.closest('button[data-copy]'); if(!b) return; navigator.clipboard.writeText(b.dataset.copy).then(()=>{ b.textContent='Copied'; setTimeout(()=>b.textContent='Copy Message', 1200); }); });
      $('#openAllWA').addEventListener('click', ()=>{ $$('#waLinks a').forEach(a=>window.open(a.href,'_blank')); });
      $('#copyWAMessages').addEventListener('click', async ()=>{ const msgs=$$('#waLinks button[data-copy]').map(b=>b.dataset.copy).join('\\n\\n---\\n\\n'); await navigator.clipboard.writeText(msgs||''); alert('Copied messages to clipboard.'); });
      $('#composeEmailBtn').addEventListener('click', ()=>{ const sc=currentScript(); const subject=($('#emailSubject')?.value||sc?.subject||'').trim(); const body=(sc?sc.body:($('#messagePreview')?.value||'')); const targets=contacts.filter(c=>selectedIds.has(c.id)&&c.email); const bcc=targets.map(c=>c.email).join(','); const url='mailto:?bcc='+encodeURIComponent(bcc)+'&subject='+encodeURIComponent(subject)+'&body='+encodeURIComponent(body); window.location.href=url; });
      $('#copyEmailList').addEventListener('click', async ()=>{ const targets=contacts.filter(c=>selectedIds.has(c.id)&&c.email); const list=targets.map(c=>c.email).join(','); await navigator.clipboard.writeText(list); alert('Copied email list.'); });

      // Data source modal
      const dataDlg=$('#dataModal');
      $('#openDataBtn').addEventListener('click', ()=>{ $('#storageLocal').checked=settings.mode==='local'; $('#storageSheet').checked=settings.mode!=='local'; $('#sheetUrl').value=settings.sheetUrl||''; $('#sheetName').value=settings.sheetName||'Contacts'; $('#webAppUrl').value=settings.webAppUrl||''; dataDlg.showModal(); });
      $('#cancelData').addEventListener('click', ()=>dataDlg.close());
      $('#saveData').addEventListener('click', (e)=>{ e.preventDefault(); settings.mode=$('#storageSheet').checked?'sheet':'local'; settings.sheetUrl=$('#sheetUrl').value.trim(); settings.sheetName=$('#sheetName').value.trim()||settings.sheetName||'Contacts'; settings.webAppUrl=$('#webAppUrl').value.trim()||settings.webAppUrl; saveLocal(STORAGE.settings, settings); dataDlg.close(); alert('Data source saved.'); });
      $('#btnLoadFromSheet').addEventListener('click', async (e)=>{ e.preventDefault(); settings.mode='sheet'; settings.sheetUrl=$('#sheetUrl').value.trim(); settings.sheetName=$('#sheetName').value.trim()||settings.sheetName||'Contacts'; settings.webAppUrl=$('#webAppUrl').value.trim()||settings.webAppUrl; saveLocal(STORAGE.settings, settings); await loadFromSheet(); });
      $('#btnSaveToSheet').addEventListener('click', async (e)=>{ e.preventDefault(); settings.mode='sheet'; settings.sheetUrl=$('#sheetUrl').value.trim(); settings.sheetName=$('#sheetName').value.trim()||settings.sheetName||'Contacts'; settings.webAppUrl=$('#webAppUrl').value.trim()||settings.webAppUrl; saveLocal(STORAGE.settings, settings); await saveToSheet(); });

      // Sign-in
      const loginDlg=$('#loginModal');
      function refreshUserUI(){ const badge=$('#userBadge'); const nameSpan=$('#userNameBadge'); const signInBtn=$('#signInBtn'); if(currentUser){ nameSpan.textContent=(currentUser.name||'User') + ' (' + (currentUser.mobile || currentUser.email || '') + ')'; badge.classList.remove('hidden'); signInBtn.classList.add('hidden'); } else { badge.classList.add('hidden'); signInBtn.classList.remove('hidden'); } }
      $('#signInBtn').addEventListener('click', ()=>{ $('#loginEmail').value=currentUser?.email||''; $('#loginName').value=currentUser?.name||''; $('#loginMobile').value=currentUser?.mobile||''; loginDlg.showModal(); });
      $('#cancelLogin').addEventListener('click', ()=>loginDlg.close());
      $('#confirmLogin').addEventListener('click', (e)=>{ e.preventDefault(); const email=$('#loginEmail').value.trim(); const name=$('#loginName').value.trim(); const mobile=normalizePhoneSA($('#loginMobile').value.trim()); if(!email||!name||!mobile){ alert('Please capture Email, Name and Mobile.'); return; } currentUser={email,name,mobile}; saveLocal(STORAGE.user, currentUser); settings.mode='sheet'; settings.sheetName = (name||'user').toLowerCase().replace(/[^a-z0-9]+/g,'-').slice(0,24) + '_' + String((mobile||'').replace(/\\D/g,'')).slice(-4); saveLocal(STORAGE.settings, settings); loginDlg.close(); refreshUserUI(); });
      $('#signOutBtn').addEventListener('click', ()=>{ if(!confirm('Sign out and clear local contacts?')) return; localStorage.removeItem(STORAGE.user); currentUser=null; contacts=[]; saveLocal(STORAGE.contacts, contacts); renderContacts(); refreshUserUI(); });

      refreshUserUI();
    });

    function openScriptModal(existing=null){
      const dialog=$('#scriptModal');
      $('#scriptModalTitle').textContent = existing ? 'Edit Script' : 'New Script';
      $('#scriptName').value = existing?.name || '';
      $('#scriptSubject').value = existing?.subject || '';
      $('#scriptBody').value = existing?.body || '';
      dialog.showModal();
      $('#saveScript').onclick = (e)=>{ e.preventDefault(); const name=$('#scriptName').value.trim(); if(!name) return; const subj=$('#scriptSubject').value.trim(); const body=$('#scriptBody').value; if(existing){ existing.name=name; existing.subject=subj; existing.body=body; } else { scripts.unshift({ id: uid(), name, subject: subj, body }); } saveLocal(STORAGE.scripts, scripts); renderScripts(); dialog.close(); };
      $('#cancelScript').onclick = ()=> dialog.close();
    }
  </script>
</body>
</html>
